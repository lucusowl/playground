# 윈도우 보안

## 1. 윈도우 특징

HW -> HAL(`Hardware Abstraction Layer`) -> 마이크로 커널 -> 각종 관리자 -> 응용프로그램
- kernel mode: HW ~ 각종 관리자
- user mode: 응용프로그램

특징
- GUI 환경
- Plug & Play: 하드웨어 자동 인식 + 환경설정 지원

### 1.1. 윈도우 파일시스템

- FAT16
  - 최대 2GB 파티션 구성가능
  - 클러스터 크기(파일 단위) = 32KB
- FAT32
  - 윈도우 95 OSR2 부터 지원
  - $2^{32}$개의 클러스터 지원 -> 고용량 지원
  - 접근제어 설정불가 -> 보안 낮음
  - 저용량 볼륨에 최적화
- NTFS
  - `New Technology File System`
  - 윈도우 NT 계열부터 지원[^1]
  - FAT 보다 결함관리(Hotfixing) 성능 높음
  - 개별 파일/폴더 암호화 지원
  - 개별 파일/폴더 사용권한 설정 가능
  - 파일 감사[^2] 기능 제공
  - 대용량 볼륨에 최적화
  - 개별 데이터 자동 압축 기능 제공

윈도우에서 하드디스크 성능 최적화는 NTFS가 유일한 선택지

#### NTFS 구조

- MBR, `Master Boot Record`
  - 파티션 1번째 섹터, 512 Byte
  - 구성: 부트 코드, 파티션 테이블, 시그니처
  - OS부팅시, BIOS에서 부트코드 호출 -> VBR 부트코드 호출 -> OS 구동
- VBR, `Volume Boot Record`
  - 파티션 2번째 섹터
  - 구성: 윈도우 부트코드, 볼륨/클러스터 크기, MFT 시작주소
  - 파티션 마지막 섹터에 VBR 백업본
- MFT, `Master File Table`
  - 파티션 3번째 섹터(**핵심영역**)
  - 구성: 모든 파일/폴더 정보 엔트리 테이블
  - 각 엔트리는 파일속성들로 구성
- 시스템 파일
  - 구성: 디스크 사용 로그[^3], 디스크 볼륨 정보
- 파일 데이터
  - 각 파일의 실제 데이터 저장

#### 디스크 파괴 악성코드

MBR 이나 VBR을 훼손 -> 컴퓨팅 부팅 불가

복구방법
- MBR은 정상파티션에서 복사 + (파티션 정보 수집 -> 파티션 테이블)
- VBR은 VBR백업본으로부터 복구

### 1.2. 윈도우 부팅순서

...

## 2. 윈도우 보안

### 2.1. 윈도우 설치

파티션 나누기 중요  
물리적인 하드디스크에 **논리적 분할 영역** 설정  
한 영역에서 발생한 문제가 다른 영역으로 번지지 않게 하기 위함  

### 2.2. 윈도우 계정, 권한, 인증

기본 사용자, 윈도우 설치시 기본 생성됨  
자세한 사용자 정보는 `컴퓨터관리 > 로컬사용자 및 그룹 > 사용자`에서 확인
| 계정이름      | 설명                                                                                                      |
| ------------- | --------------------------------------------------------------------------------------------------------- |
| Guest         | 매우 제한적 권한                                                                                          |
| Administrator | 관리자 권한 계정, 사용자가 사용가능한 가장 강력한 권한 소유                                               |
| SYSTEM        | 시스템 최고 권한, 로컬에서 관리자보다 상위 권한, 원격접속 불가, 사용자는 이 계정으로 시스템에 로그인 불가 |

기본 그룹, 기본 생성됨  
자세한 그룹 정보는 `컴퓨터관리 > 로컬사용자 및 그룹 > 그룹`에서 확인
| 그룹이름          | 설명                                                                                                |
| ----------------- | --------------------------------------------------------------------------------------------------- |
| Administrator     | 도메인 자원/로컬 컴퓨터 모든 권한                                                                   |
| Account Operators | 계정 관리 그룹                                                                                      |
| Backup Operators  | 시스템 백업을 위해 파일시스템 접근 가능                                                             |
| Print Operators   | 도메인 내 프린터 접근 가능                                                                          |
| Server Operators  | 도메인 내 서버 관리 그룹, 로컬 로그인 가능, 시스템 재시작/종료 가능                                 |
| Replicator        | 도메인 내 파일 복제 권한 그룹                                                                       |
| Power Users       | 디렉터리/네트워크 공유 설정 가능, 공용프로그램 그룹 설정 가능, 컴퓨터시간 설정 가능                 |
| **Users**         | 일반 사용자 그룹, 개별 사용자 환경 설정은 가능, 시스템 서비스 시작/종료불가, 디렉터리 공유 설정불가 |
| Guests            | 도메인 사용권한 제한 그룹, 설정변경 불가                                                            |

#### SID

`Security IDentifier`  
각 사용자(계정), 그룹에 부여되는 고유 식별번호  
- 각기 다른 시스템의 관리자를 구분할 수 있음
- 파일시스템에 접근 통제에 활용
- 구체적인 SID 정보(Well-Known SID Structures)는 [참고 확인](https://msdn.microsoft.com/en-us/library/81d92bba-d22b-4a8c-908a-554ab29148ab)  

```
S-1-{IdentifierAuthority}-{SubAuthority,}-{RID}
```

- `S-1` : revision number, SID 명세 버전
- `{IdentifierAuthority}` : Identifier authority value
- `{SubAuthority,}` : Sub-authrity values, 각 서브시스템 고유번호들(도메인, 로컬컴 구분자)
  - 시스템 생성시 부여
- `{RID}` : Relative ID, SID 마지막 번호
  - 500: Administrator 계정
  - 501: Guest 계정
  - 1000이상: 일반 사용자 계정

```powershell
whoami /user # 로그인한 사용자 SID 확인
```

#### 윈도우 권한 상승 공격

Administrator나 SYSTEM의 권한(상위 권한)으로 수행되는 프로세스의 권한을 빼앗는 수법  

상위 권한으로 수행되고 있는 프로세스에 다른 작업을 끼워넣는 방식으로 진행

#### 윈도우 로그인 인증

![윈도우 인증 구조]()

- LSA, `Local Security Authority`
  - 모든 계정의 로그인 검증
  - 시스템 자원 접근 권한을 검사
  - SRM이 생성한 감사 로그를 기록
  - Security Subsystem이라 불리기도 함
- SAM, `Security Account Manager`
  - 사용자/그룹 계정 정보 데이터베이스 관리
  - 로그인 입력 정보와 SAM 데이터베이스(인증 정보)를 비교해 **인증 여부 결정**
  - SAM 파일은 `%systemroot%/system32/config/sam`에 위치[^4]
  - **접근 통제가 필요**한 파일이므로 Administrator나 SYSTEM만 접근 허용할 것
- SRM, `Security Reference Monitor`
  - SAM이 로그인정보(계정-패스워드) 일치 여부 -> SRM
  - SRM -> 사용자, SID를 부여
  - 향후, 이 SID를 기반으로 파일시스템 접근 통제 + 감사 메시지 생성됨

### 2.3. 공유자원 관리

네트워크 드라이브: 다른 컴퓨터의 드라이브를 내 컴퓨터의 드라이브처럼 사용  

네트워크 드라이브 설정법
1. ```cmd
   net use {드라이브명}: \\{IP}\{대상드라이브명}$
   ```
2. 계정 이름, 비번 입력

#### 파일과 폴더 보안 권한 설정

> [!TIP]
> 파일/폴더을 안전하게 관리하기 위해서는
> 1. 파일/폴더 권한 설정
> 2. 파일/폴더 암호화
> 3. 전체 하드디스크 암호화

권한 종류
- `모든 권한`: 아래 모든 권한
- `폴더 내용 보기`: **폴더만 해당**, 폴더 내 내용 읽기 가능
- `읽기`: 폴더 내 내용만 읽기 가능
- `읽기 및 실행`: "읽기" + 폴더/파일 이동 가능
- `쓰기`: 서브 생성, 권한 설정 가능
- `수정`: "읽기 및 실행" + "쓰기"

권한 설정법
- `폴더|파일 {오른클릭} > 속성 > 보안 > 편집`, 사용권한 상자에서 설정

NTFS에서 설정한 폴더/파일의 접근 권한은 아래의 규칙을 따름
1. NTFS 접근 권한은 누적
   - 계정이 여러 그룹에 속할 경우, 각 그룹의 권한의 누적(합집합)
2. "파일 접근 권한"이 "폴더 접근 권한"보다 우선
3. "거부"가 "허용"보다 우선
   - 윈도우에서는 "허용 없음 == 거부"가 아님 주의

#### 기본 공유 폴더

- `C$`, `D$`
  - C드라이브 관리목적 공유 폴더
  - 기본 공유 폴더 -> 인가받지않은 사용자 접근 취약 -> 보안 취약
  - 연결된 하드 드라이브 수 만큼 표시됨(`E$, F$, ...`)
- `ADMIN$`
  - 윈도우 설치폴더 관리목적 공유 폴더
  - 윈도우 설치폴더(`%systemroot%`와 동일[^4]) 접근
  - 모든 윈도우를 대상으로 파일 복사/변경시 사용됨
- `IPC$`
  - `Inter Process Communication`
  - 동시에 실행되는 개별 프로그램의 생성 및 프로그램간 통신 인터페이스
  - 삭제시 네트워크 서비스 문제발생 -> 보안 취약
    - 레지스트리 값 수정, 인가받지않은 사용자 접근 불가

#### 공유 폴더 관리

공유 리소스 설정시, 공유드라이브명 끝에 `$`를 붙이면  
네트워크 원격 연결시 리소스 목록에 나타나지 않음 -> 공유 폴더 숨기기

숨겨진 공유 폴더 보는 방법은 아래 명령어로 확인
```cmd
net share
```

그러나 기본 공유 폴더는 숨기더라도 알려진 이름을 가지고 있으므로 공유 비활성화를 권장  
해당 방법과 구체적인 공유 폴더 보안 설정은 ["3.2. 서비스 관리 - 하드디스크 기본 공유 제거"](#32-서비스-관리) 내용 참고

### 2.4. 암호기능 사용

- EFS(`Encrypting File System`)
  - 특정 파일, 특정 폴더 내 모든 파일 암호화
  - **파일 단위 암호화**
  - `폴더|파일 {오른클릭} > 속성 > 일반 > 고급`, 고급특성 상자에서 설정
  - 인증서 추가/삭제를 통해 특정파일/폴더 읽을 수 있는 사용자 추가/삭제
  - **사용자 단위 데이터암호화**
  - 암호화키 생성방법 : **인증서**

- 볼륨 암호화, `BitLocker`
  - BitLocker 활성화 -> 볼륨(논리적 파티션)내 모든 파일이 암호화
  - **디스크 단위 암호화**
  - 시스템 파티션은 제외 (사유; 부팅 관여)
  - **컴퓨터 단위 데이터암호화**
  - 암호화키 생성방법 : **패스워드**
  - 악의적인 사용자 접근(물리적 접근 포함) 방지에 도움

파일 암호 알고리즘 구분

| 윈도우 버전                                     | EPS 알고리즘 | Bitlocker 알고리즘 |
| ----------------------------------------------- | ------------ | ------------------ |
| Windows 2000<br>Windows Server 2000             | DESX, TDES   | -                  |
| Windows XP SP1<br>Windows Server 2003           | AES-256      | -                  |
| Windows Vista, Windows 7<br>Windows Server 2008 | AES-256      | AES-128/256        |

### 2.5. 레지스트리 활용

#### 레지스트리
시스템 운영,설정 정보가 담긴 DB  
레지스트리 편집기(`regedit`를 cmd에 입력)를 통해 CRUD  
설치된 소프트웨어 환경설정 정보, 임시 저장 정보를 담음 -> 사고분석에 있어 공격자 흔적을 찾을 수 있음, 레지스트리 공격 [항목 참고](#레지스트리-공격)

#### 레지스트리 루트키
가장 상위에 해당하는 레지스트리 키, 특수키로 핸들이라고도 불림  
윈도우 부팅시 하이브 파일[^5]에서 값을 읽어와 구성

- `Master Key`: 하이브 파일에서 직접 불어와 구성되는 키

  - **`HKLM`**, (`HKEY_LOCAL_MACHINE`)
    - 컴퓨터에 설치된 하드웨어, 드라이버(하드웨어 구동), 설정 정보
    - 루트키 중 가장 다양한 하이브 파일로 구성
    - 서브키
      - `HKLM\HARDWARE`, 메모리
        - 부팅시 감지된 모든 하드웨어 + 장치 드라이버 매핑 정보
        - `장치관리자`를 통해 확인가능
      - `HKLM\SAM`, `%windows%\System32\Config\Sam`
        - 로컬 사용자 계정/그룹 정보(패스워드, 소속그룹, 도메인, ...)
        - 액티브 디렉터리에 도메인 계정과 그룹 정보 저장 + 컴퓨터는 도메인 컨트롤러 서버
        - 시스템 계정외 접근 불가
      - `HKLM\SECURITY`, `%windows%\System32\Config\Security`
        - 시스템 보안 정책, 사용자 권리 할당 정보
        - 시스템 계정외 접근 불가
      - `HKLM\SOFTWARE`, `%windows%\System32\Config\software`
        - 시스템 소프트웨어 목록 + 각 환경설정 정보
        - APP이름, 경로, 라이선스 정보, 만료일, ...
      - `HKLM\SYSTEM`, `%windows%\System32\Config\System`
        - 부팅시 필요한 시스템 환경설정 정보 -> 중요데이터
        - 로드 디바이스 드라이버, 시작시킬 서비스 목록
        - 부팅성공시 복사본 생성, 비정상적 종료시 복사본 바탕으로 부팅
      - HKLM를 구성하는 각 하이브 위치
        | HKLM 서브키         | 하이브 위치                          |
        | ------------------- | ------------------------------------ |
        | `HKLM\HARDWARE`     | 메모리                               |
        | `HKLM\SAM`          | `%windows%\System32\Config\Sam`      |
        | `HKLM\SECURITY`     | `%windows%\System32\Config\Security` |
        | `HKLM\SOFTWARE`     | `%windows%\System32\Config\software` |
        | `HKLM\SYSTEM`       | `%windows%\System32\Config\System`   |
        | `HKLM\SYSTEM\Clone` | 메모리                               |


  - **`HKU`**, (`HKEY_USERS`)
    - 시스템내 모든 계정, 그룹 정보
    - 사용자 정보 + 데스크탑 설정 + 네트워크 연결 정보 내포
    - `USER.DAT`에 내용 저장

- `Derived Key`: Master Key로부터 값을 재구성하는 키

  - **`HKCC`**, (`HKEY_CURRENT_CONFIG`)
    - 시스템 시작시, 현재 하드웨어 프로파일(디스플레이,프린터,...) 정보
    - `HKLM`의 서브로 존재하는 설정 내용 내포

  - **`HKCR`**, (`HKEY_CLASSES_ROOT`)
    - 시스템에 등록된 파일확장자 목록
    - 각 파일확장자 실행시 열릴 APP 맵핑 정보
    - COM(Component Object Model) 오브젝트 등록 정보

  - **`HKCU`**, (`HKEY_CURRENT_USER`)
    - 현재 시스템에 로그인한 사용자 정보
    - `HKU`보다 설정이 우선권을 가짐
    - `HKCU` 변경시 -> 해당 보안식별자의 `HKU`도 변경

#### 레지스트리 보호

- 레지스트리 접근 제한
  - 일반 사용자는 레지스트리 편집기을 사용하지 못하게 제한
  - UAC(User Account Control, 사용자 계정 컨트롤)를 통해 관리자 암호를 아는 사용자만 접근

- 레지스트리 현재 상태 저장
  - 윈도우 시스템 복원 기능 활용
  - `%systemroot%`에 있는 `USER.DAT`, `SYSTEM.DAT`, `SYSTEM.INI`, `WIN.INI`파일이 윈도우 시스템 백업/복구에 필요

- 레지스트리 키를 디스크에 복사
  - 키 데이터를 `.reg`파일(레지스트리 등록파일)로 저장
  - 레지스트리 변경후 문제가 발생하면 해당 레지스트리 등록파일을 실행해 복원

#### 레지스트리 공격

1. 부팅시 악성코드 실행
   1. 시스템 재부팅시 변조된 레지스트리로 악성코드 실행
      - `HKLM`(전체사용자)/`HKCU`(개별사용자)
      - `Run`(부팅마다 실행)/`RunOnce`(일회용,재부팅시 삭제됨)
   2. 변조되는 위치
      - 전체사용자 지속용: `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
      - 전체사용자 일회용: `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`
      - 개별사용자 지속용: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
      - 개별사용자 일회용: `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`

2. 특정 파일확장자 실행시 악성코드 실행
   1. 프로그램(특정 파일 확장자) 실행시 변조된 레지스트리로 악성코드 실행
      - `HKCR`을 변조
      - e.g. `[HKCR\exefile\shell\open\command]@=hacker.exe ""%1"%*"`

공격자가 주로 남기는 레지스트리 정보 수집 위치
- 최근 사용한 문서 목록: `HKCU\Software\Microsoft\windows\CurrentVersion\Explorer\Recentdocs`
- 터미널 서비스 접속 목록: `HKCU\Software\Microsoft\Terminal server Client\Default`
- 설치된 소프트웨어 목록: `HKCU\Software`
- 열어본 파일 목록: `HKCU\Software\Microsoft\windows\CurrentVersion\Explorer\ComDlg32\OpenSaveMRU`

### 2.6. 윈도우 방화벽

PC 방화벽; 네트워크 패킷의 적절성 여부를 확인, 인바운드(안으로)/아웃바운드(밖으로) 모두 차단

`설정 > 제어판 > Windows Defender 방화벽`에서  
`고급 설정 > 고급 보안이 포함된 Windows Defender 방화벽`에서 인바운드/아웃바운드 규칙 설정

윈도우 버전마다 설정 창 접근 방법은 다르므로 설정에서 `방화벽`검색

## 3. 윈도우 서버 보안 설정

### 3.1. 계정 관리

1. Administrator 계정명 변경

   알려진 관리자 이름은 보안 취약(로그인 무제한 시도 -> 패스워드 유추 공격)  
   `컴퓨터관리 > 로컬사용자 및 그룹 > 사용자`에서 관리자명 변경

2. Guest 계정 상태

   기본적으로 Guest 계정은 비활성화  
   그러나 활성화시, 공격자가 로그인하여 시스템 정보, 관리자 그룹 추가 악용 위험이 존재  
   비활성화 상태 권장  
   `컴퓨터관리 > 로컬사용자 및 그룹 > 사용자`에서 `Guest {우클릭} > 속성 > 일반 > "계정 사용 안함" {활성화}`

3. 계정 잠금 임계값과 잠금기간 설정

   로그인 시도 -> 패스워드 유추 공격 가능  
   **로그인 시도 횟수 제한**과 **계정 잠금 기간**을 설정하여 암호유추 효과를 낮출 것  
   `로컬보안정책(secpol.msc)`에서 `계정 정책 > 계정 잠금 정책`에서 해당 내용을 변경

4. 관리자 그룹에 최소한의 사용자 포함

   일반 업무와 관리 업무구분을 위해 사용자 분리 권장  
   관리자 그룹에는 최소한의 사용자만 포함할 것  
   `컴퓨터관리 > 로컬사용자 및 그룹 > 그룹`에서 `Administrators {우클릭} > 구성원`의 최소한의 계정만 설정

5. 암호와 패스워드 정책 설정

   암호 유추를 어렵게 하기위해 설정  
   길이(최소 8글자이상), 최대 사용기간(90일), 최소 사용기간(1일|1주), 등을 설정할 것  
   `로컬보안정책(secpol.msc)`에서 `계정 정책 > 암호 정책`에서 해당 내용을 변경  

### 3.2. 서비스 관리

1. 공유 권한 및 사용자 그룹 설정

   Everyone이 공유 계정에 포함되면 익명 접근이 가능  
   기본 공유 폴더를 제외한 다른 폴더의 접근 권한에서 Everyone 제거 + 특정 계정만 추가
   `컴퓨터관리 > 공유 폴더 > 공유`에서 `해당폴더명 {우클릭} > 속성 > 보안 > 사용권한 편집`에서 Everyone 제거 + 특정 계정만 추가

2. 하드디스크 기본 공유 제거

   1. 불필요한 공유 제거

      ```cmd
      net share {공유 폴더 이름} /delete
      ```

      기본 공유 폴더(`C$`,`D$`,`ADMIN$`,`IPC$`)는 관리상의 목적으로 사용하지 않는다면 제거  
      단, `IPC$`는 서비스 실행에 문제가 발생할 수 있으므로 제외  
      운영체제 재부팅하면 다시 생성되기에 레지스트리 편집도 필요  
      `HKLM\SYSTEM\CurrentControlSet\Services\lanmanserver\parameters`에서 `AutoShareServer`(Windows NT일 경우, `AutoShareWks`)의 값을 0으로 설정 (없으면 DWORD로 생성)

   2. Null Session 접근 차단 설정

      `IPC$`를 통해 null session(사용자 인증없이 네트워크 자원 접근)이 가능  
      해당 취약점은 Windows NT 4.0 및 이전 버전 / NetBIOS 프로토콜 사용 버전에서 발생  

      인증된 사용자만 접속할 수 있도록 변경  
      `HKLM\SYSTEM\CurrentControlSet\Control\LSA`에서 `restrictanonymous`값을 2로 설정 (없으면 DWORD로 생성)

3. 불필요한 서비스 제거

   시스템에 불필요한 서비스와 실행 파일은 사융 중지 및 제거할 것  
   `컴퓨터관리 > 서비스 및 응용 프로그램 > 서비스`에서 `해당서비스 {우클릭} > "중지" > 시작 유형: "사용 안함"`  

   대표적인 취약 서비스는 아래와 같음  
   - Alerter
   - Clipbook
   - Messenger
   - Simple TCP/IP Services

### 3.3. 패치 관리

1. 감사 정책에 따른 시스템 로깅 설정

   감사 설정이 구성되지 않았거나 감사 수준이 너무 낮으면 -> 법적대응에 증거불충분  
   감사 설정 수준이 너무 높으면 -> 불필요한 항목 기록, 중요 항목과 혼동, 성능저하  

   때문에 법적 요구사항과 조직정책에 따라 필요 로그 설정

   `로컬보안정책(secpol.msc)`에서 `로컬 정책 > 감사 정책`에서 해당 항목 성공/실패 감사를 설정  
   권장 감사 정책 설정은 아래의 표와 같음
   | 감사 항목              | 권장값     | 설명 |
   | ---------------------- | ---------- | ---- |
   | 개체 액세스            | 감사 안함  |  |
   | 계정 관리              | 실패       |  |
   | 계정 로그온 이벤트     | 성공,실패  |  |
   | 권한 사용              | 실패       |  |
   | 디렉터리 서비스 액세스 | 실패       |  |
   | 로그온 이벤트          | 성공, 실패 |  |
   | 시스템 이벤트          | 감사 안함  |  |
   | 정책 변경              | 성공,실패  | 감사 정책 변경 |
   | 프로세스 추적          | 감사 안함  |  |

## 4. 윈도우 네트워크 서비스

네트워크 디렉토리 서비스는 사용자들에게 리소스 투명하게 제공  
대표적인 디렉토리 서비스로
- `LDAP`(Lightweight Directory Access Protocol)
- `NDS`(Novell netware Directory Service)
- `Microsoft Active Directory`

### Active Directory
네트워크 개체에 대한 정보 저장, 관리자/사용자가 편리하게 정보 이용 목적  
디렉터리 정보를 논리적인 계층구조로 조직  
Active Directory 서버는 도메인 내 "구성원 서버" 또는 "도메인 컨트롤러" 역할 중 하나를 수행

# 추가 References

- [velog, Windows Server 취약점 - Null Session, 240416](https://velog.io/@fivedumplings/Windows-Server-%EC%B7%A8%EC%95%BD%EC%A0%90-Null-Session)

[^1]: FAT + HPFS 의 장점을 모음
[^2]: Auditing, 특정 계정의 파일열람시각 + 열람실패시각 기록
[^3]: 파일 복사/삭제 과정 중 시스템 오류 대비
[^4]: `%systemroot%` 는 기본설치 기준 `C:/Windows`(WinXP이상), `C:/Winnt`(Win2000)에 해당
[^5]: 레지스트리 DB 하위 집합에 여러 개의 파일로 구성, 하이브에는 레지스트리 키, 서브키, 설정항목이 들어있음
